{% extends 'inventory/base.html' %}
{% load crispy_forms_tags %}
{% block content %}
<a href="{% url 'dashboard' %}" class="btn btn-outline-primary my-3 mx-4">Go Back</a>
<div class="row">
  <div class="col-11 col-md-4 mx-auto mt-5">
    <h1>Inventory Item</h1>
    <!-- Barcode Scanner Section -->
    <div id="barcode-scanner-section" class="my-4">
      <h2>Scan Barcode</h2>
      <button id="startScan" class="btn btn-info">Start Scanning</button>
      <button id="stopScan" class="btn btn-danger" style="display: none;">Stop Scanning</button>
      <!-- Container for the video feed -->
      <div id="scanner-container" style="width: 100%; height: 200px;"></div>
      <!-- Display Barcode Result Here -->
      <div id="barcodeResult" class="mt-2">Barcode result will appear here</div>
    </div>
    <form method="POST">
      {% csrf_token %}
      {{ form|crispy }}
      <div class="mt-3">
        <button class="btn btn-primary">Add Item</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.rawgit.com/serratus/quaggaJS/0420d5e0/dist/quagga.min.js"></script>
<script>
  const startScanButton = document.getElementById('startScan');
  const stopScanButton = document.getElementById('stopScan');
  const scannerContainer = document.getElementById('scanner-container');
  const barcodeResult = document.getElementById('barcodeResult');

  startScanButton.addEventListener('click', startScanner);
  stopScanButton.addEventListener('click', stopScanner);

  function startScanner() {
    startScanButton.style.display = 'none';
    stopScanButton.style.display = 'inline-block';

    Quagga.init({
      inputStream: {
        name: 'Live',
        type: 'LiveStream',
        target: scannerContainer,
        constraints: {
          width: 640,
          height: 480,
          facingMode: 'environment'
        }
      },
      decoder: {
        readers: ['ean_reader', 'upc_reader'] // Specify the barcode types to scan
      }
    }, function(err) {
      if (err) {
        console.error(err);
        return;
      }
      console.log('Initialization finished. Ready to start');
      Quagga.start();
    });

    Quagga.onDetected(function(result) {
      const code = result.codeResult.code;
      console.log('Barcode detected:', code);
      barcodeResult.textContent = 'Barcode: ' + code;
      stopScanner();
    });
  }

  function stopScanner() {
    startScanButton.style.display = 'inline-block';
    stopScanButton.style.display = 'none';

    Quagga.stop();
    Quagga.offDetected();
  }
</script>
{% endblock content %}